#!/usr/bin/env node

var path = require('path'),
    util = require('util'),
    exec = require('child_process').exec,
    fs = require('fs'),
    http = require('http'),
    Q = require('q'),
    $ = require('jQuery'),
    requirejs = require('requirejs');

// initialize

var rootDir = path.dirname(path.normalize(__dirname)),
    port = 8080,
    address = '127.0.0.1',
    templateDir = rootDir + '/template',
    templatesPath = rootDir + '/target/templates.js',
    javascriptRollupPath = rootDir + '/target/index.js',
    indexHtmlPath = rootDir + '/target/index.html',
    viewDir = rootDir + '/view',
    tvFinderContent,
    rollupJavascriptCommand = [
        'node',
        '/usr/local/lib/node_modules/requirejs/bin/r.js',
        '-o',
        rootDir + '/config/rs.json'
    ].join(' '),
    compileRenderersCommand = [
        'handlebars',
        '--amd',
        templateDir + '/*.hbs',
        '--output',
        templatesPath
    ].join(' ');

var qCompilePage,
    qRenderPage,
    qCreateJavascriptRollup,
    qCompileRenderers;

requirejs.config({
        baseUrl: rootDir,
        'handlebars': {
            exports: 'Handlebars'
        }
    }
);

requirejs(['Backbone', 'jQuery'], function (Backbone, $) {
    Backbone.$ = $; // necessary, why?
});

// execution

Q.all([compilePage(), createJavascriptRollup()]).then(
    function () {
        servePage();
    },
    function (error) {
        console.error(error.message);
        process.exit(1);
    }
);

// serve the page

function servePage() {
    var pathMap = [
        { pattern: /^(\/target)?\/index\.css$/, action: serveCss },
        { pattern: /^(\/target)?\/index\.js/, action: serveJavascriptRollup },
        { pattern: /^(\/target)?\/index\.html/, action: serveTvFinderHtml },
        { pattern: /^\/(css\/.*\.css)$/, action: serveCss },
        { pattern: /^\/(js\/.*\.js)$/, action: serveJavascript },
        { pattern: /^\/(i\/.*\.png)$/, action: servePng },
        { pattern: /^\/(font\/.*\.otf)$/, action: serveFont },
        { pattern: /^\/$/, action: serveTvFinderHtml }
    ];
    http.createServer(function (req, res) {
            for (index = 0; index < pathMap.length; index++) {
                values = req.url.match(pathMap[index].pattern);
                if (values) {
                    pathMap[index].action(values, req, res).fail(
                        function (error) {
                            if (error.code === 'ENOENT') {
                                notFound(req, res);
                            }
                            else {
                                console.error(req.url, error);
                                res.writeHead(500, {'Content-Type': 'text/plain' });
                                res.end('server error: ' + error.code + ': ' + error.errno);
                            }
                        }
                    );
                    return;
                }
            }
            notFound(req, res);
        }
    ).listen(port, address);
    console.log('started server ' + address + ' on port ' + port);
}

function notFound(req, res) {
    res.writeHead(404, {'Content-Type': 'text/plain' });
    res.end('not found');
}

function serveCss(values, req, res) {
    var qServeCss = Q.defer();
    fs.readFile(values[1], 'ascii', function (error, contents) {
            if (error) {
                qServeCss.reject(error);
            }
            else {
                res.writeHead(200, { 'Content-Type': 'text/css' });
                res.end(contents);
                qServeCss.resolve();
            }
        }
    );
    return qServeCss.promise;
}

function serveJavascriptRollup(values, req, res) {
    var qServeJavascriptRollup = Q.defer();
    createJavascriptRollup().then(function () {
            fs.readFile(rootDir + "/target/index.js", 'ascii', function (error, contents) {
                    if (error) {
                        qServeJavascriptRollup.reject(error);
                    }
                    else {
                        res.writeHead(200, { 'Content-Type': 'application/javascript' });
                        res.end(contents);
                        qServeJavascriptRollup.resolve();
                    }
                }
            );
        },
        function (error) {
            qServeJavascriptRollup.reject(error);
        }
    );
    return qServeJavascriptRollup.promise;
}

function serveJavascript(values, req, res) {
    var qServeJavascript = Q.defer();
    fs.readFile(values[1], 'ascii', function (error, contents) {
            if (error) {
                qServeJavascript.reject(error);
            }
            else {
                res.writeHead(200, { 'Content-Type': 'application/javascript' });
                res.end(contents);
                qServeJavascript.resolve();
            }
        }
    );
    return qServeJavascript.promise;
}

function servePng(values, req, res) {
    var qServePng = Q.defer();
    fs.readFile(values[1], function (error, contents) {
            if (error) {
                qServePng.reject(error);
            }
            else {
                res.writeHead(200, { 'Content-Type': 'image/png' });
                res.end(contents);
                qServePng.resolve();
            }
        }
    );
    return qServePng.promise;
}

function serveFont(values, req, res) {
    var qServeFont = Q.defer();
    fs.readFile(values[1], function (error, contents) {
            if (error) {
                qServeFont.reject(error);
            }
            else {
                res.writeHead(200, { 'Content-Type': 'font/opentype' });
                res.end(contents);
                qServeFont.resolve();
            }
        }
    );
    return qServeFont.promise;
}

function serveTvFinderHtml(values, req, res) {
    var qServeTvFinderHtml = Q.defer();
    compilePage()
        .then(function (tvFilterContent) {
            res.writeHead(200, { 'Content-Type': 'text/html' });
            res.end(tvFilterContent);
            qServeTvFinderHtml.resolve();
        })
        .fail(function (error) {
            qServeTvFinderHtml.reject(error);
        });
    return qServeTvFinderHtml.promise;
}

// compile the page

function compilePage() {
    if (!qCompilePage) {
        qCompilePage = Q.defer();
        Q.all([renderPage(), statGeneratedFile(indexHtmlPath)]).then(
            function (updated, stat) {
                if (updated || !tvFinderContent) {
                    tvFinderContent = '<!doctype html>\n\n';
                    tvFinderContent += $("html")[0].outerHTML;
                    tvFinderContent = tvFinderContent.replace(/<!--#/g, '<');
                    tvFinderContent = tvFinderContent.replace(/#-->/g, '>');
                }
                if (updated || !stat) {
                    fs.writeFile(rootDir + '/target/index.html', tvFinderContent, function (error) {
                    });
                }
                qCompilePage.resolve(tvFinderContent);
                qCompilePage = undefined;
            },
            function (error) {
                qCompilePage.reject(error);
            }
        );
    }
    return qCompilePage.promise;
}

// render the page

function renderPage() {
    if (!qRenderPage) {
        qRenderPage = Q.defer();
        compileRenderers().then(
            function (updated) {
                if (updated) {
                    console.log('rendering page');
                    requirejs(['Backbone', 'view/TvFinder'], function (Backbone, TvFinder) {
                        var model = new Backbone.Model({
                                greeting: 'Hello'
                            }
                        );
                        $("head").html('');
                        $("body").html('');
                        new TvFinder({ model: model }).render();
                        qRenderPage.resolve(true);
                        qRenderPage = undefined;
                    });
                }
                else {
                    qRenderPage.resolve(false);
                    qRenderPage = undefined;
                }
            },
            function (error) {
                qRenderPage.reject(error);
            }
        );
    }
    return qRenderPage.promise;
}

// compile rollups

function createJavascriptRollup() {
    if (!qCreateJavascriptRollup) {
        qCreateJavascriptRollup = Q.defer();
        compileRenderers().then(
            function () {
                var rollupStatPromise = statGeneratedFile(javascriptRollupPath),
                    viewStatsPromise = statFilesInDirectoryMatching(viewDir, /\.js$/),
                    compilationStatPromise = Q.nfcall(fs.stat, templatesPath);
                Q.all([rollupStatPromise, viewStatsPromise, compilationStatPromise]).then(
                    function (stats) {
                        var rollupStat = stats[0],
                            viewStats = stats[1],
                            compilationMtime = stats[2].mtime.getTime(),
                            rollupMtime = rollupStat ? rollupStat.mtime.getTime() : 0,
                            isOlder = rollupMtime < compilationMtime,
                            index = 0;
                        while (!isOlder && index < viewStats.length) {
                            isOlder = rollupMtime < viewStats[index].mtime.getTime();
                            index++;
                        }
                        if (isOlder) {
                            console.log('creating javascript rollup');
                            exec(rollupJavascriptCommand, function (error, out, err) {
                                    if (error) {
                                        qCreateJavascriptRollup.reject(new Error(out)); // compile error
                                    }
                                    else {
                                        qCreateJavascriptRollup.resolve(true);
                                        qCreateJavascriptRollup = undefined;
                                    }
                                }
                            );
                        }
                        else {
                            qCreateJavascriptRollup.resolve(false);
                            qCreateJavascriptRollup = undefined;
                        }
                    },
                    function (error) {
                        qCreateJavascriptRollup.reject(error);
                    }
                );
            },
            function (error) {
                qCreateJavascriptRollup.reject(error);
            }
        );
    }
    return qCreateJavascriptRollup.promise;
}

// compile renderers only when necessary

function compileRenderers() {
    if (!qCompileRenderers) {
        qCompileRenderers = Q.defer();
        var compilationStatPromise = statGeneratedFile(templatesPath),
            templateStatsPromise = statFilesInDirectoryMatching(templateDir, /\.hbs$/);
        Q.all([compilationStatPromise, templateStatsPromise]).then(
            function (statsPromises) {
                var targetMtime = statsPromises[0] ? statsPromises[0].mtime.getTime() : 0,
                    templateFileStats = statsPromises[1], sourceMtime, isOlder = targetMtime === 0, index = 0;
                while (!isOlder && index < templateFileStats.length) {
                    isOlder = targetMtime < templateFileStats[index].mtime.getTime();
                    index++
                }
                if (isOlder) {
                    console.log('compiling renderers')
                    exec(compileRenderersCommand, function (error, out, err) {
                            if (error) {
                                qCompileRenderers.reject(new Error(err));
                            }
                            else {
                                requirejs.undef('target/templates');
                                requirejs(['target/templates'], function () {
                                    qCompileRenderers.resolve(true);
                                    qCompileRenderers = undefined;
                                });
                            }
                        }
                    );
                }
                else {
                    qCompileRenderers.resolve(false);
                    qCompileRenderers = undefined;
                }
            },
            function (error) {
                qCompileRenderers.reject(error);
            }
        );
    }
    return qCompileRenderers.promise;
}

// utilities

function statGeneratedFile(path) {
    var qStatGeneratedFile = Q.defer();
    fs.stat(path, function (error, stat) {
        if (error) {
            if (error.code === 'ENOENT') {
                qStatGeneratedFile.resolve(undefined);
            }
            else {
                qStatGeneratedFile.reject(error);
            }
        }
        else {
            stat.path = path;
            qStatGeneratedFile.resolve(stat);
        }
    });
    return qStatGeneratedFile.promise;
}

function statFilesInDirectoryMatching(path, pattern) {
    var qStatFilesInDirectoryMatching = Q.defer();

    fs.readdir(path, function (error, files) {
        if (error) {
            qStatFilesInDirectoryMatching.reject(error);
        }
        else {
            function fsStat(path) {
                var qFsStat = Q.defer();
                fs.stat(path, function (error, stat) {
                    if (error) {
                        qFsStat.reject(error);
                    }
                    else {
                        stat.path = path;
                        qFsStat.resolve(stat);
                    }
                });
                return qFsStat.promise;
            }

            var statPromises = [];
            for (var index = 0; index < files.length; index++) {
                if (!pattern || files[index].match(pattern)) {
                    statPromises.push(fsStat(path + '/' + files[index]));
                }
            }
            Q.all(statPromises).then(
                function (stats) {
                    qStatFilesInDirectoryMatching.resolve(stats);
                },
                function (error) {
                    qStatFilesInDirectoryMatching.reject(error);
                }
            );
        }
    });
    return qStatFilesInDirectoryMatching.promise;
}
