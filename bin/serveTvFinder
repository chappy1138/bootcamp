#!/usr/bin/env node

var path = require('path'),
    exec = require('child_process').exec,
    Q = require('q'),
    $ = require('jQuery'),
    requirejs = require('requirejs');

// initialize

var rootDir = path.dirname(path.normalize(__dirname));

requirejs.config({
        baseUrl: rootDir,
        'handlebars': {
            exports: 'Handlebars'
        }
    }
);

requirejs(['Backbone', 'jQuery'], function (Backbone, $) {
    Backbone.$ = $; // necessary, why?
});

// execution

compileRenderers()
    .then(renderApp)
    .then(function (content) {
        console.log(content);
        process.exit(0);
    })
    .fail(function (err) {
        console.error(err.message);
        process.exit(1);
    });

// render the page

function renderApp() {
    var renderApp = Q.defer();
    requirejs(['jQuery', 'app/Application'], function ($) {
        renderApp.resolve($("html")[0].outerHTML);
    });
    return renderApp.promise;
}

/// compile renderers

function compileRenderers() {
    var compileRenderers = Q.defer(),
        compileCommandLine = [
            'handlebars',
            '--amd',
            rootDir + '/template/*.hbs',
            '--output',
            'app/templates.js'
        ].join(' ');
    exec(compileCommandLine, function (error, out, err) {
            if (error) {
                compileRenderers.reject(new Error(err)); // compile error
            }
            compileRenderers.resolve();
        }
    );
    return compileRenderers.promise;
}
